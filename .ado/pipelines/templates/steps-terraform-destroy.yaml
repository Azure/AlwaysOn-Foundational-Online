parameters:
  terraformStorageAccountName:       ''
  terraformStorageResourceGroupName: ''
  terraformStateFilename:            ''
  terraformWorkingDirectory:         ''
  customAttributes:                  ''  # custom attributes for terraform
  retryCount:                        1   # how often this task will retry
  retryDelayInSeconds:               90  # wait period before retrying

steps:

# Initialize Terraform for destroy
- template: steps-terraform-init.yaml
  parameters:
    terraformStorageAccountName:        '${{ parameters.terraformStorageAccountName }}'
    terraformStorageResourceGroupName:  '${{ parameters.terraformStorageResourceGroupName }}'
    terraformStateFilename:             '${{ parameters.terraformStateFilename }}'
    terraformWorkingDirectory:          '${{ parameters.terraformWorkingDirectory }}'

- task: PowerShell@2
  displayName: 'Terraform destroy'
  name: 'terraformdestroy'
  inputs:
    workingDirectory: '${{ parameters.terraformWorkingDirectory }}'
    targetType: inline
    script: |
      # To have access to the input ARM_CLIENT_SECRET which was marked as secret, we need to explicitly reference it in the script
      export ARM_CLIENT_SECRET="$(ARM_CLIENT_SECRET)"

      $retrycount = 0
      $maxretrycount = ${{ parameters.retryCount }}
      $retrydelay = ${{ parameters.retryDelayInSeconds }}

      do {
        Write-Host "*** Terraform destroy ($retrycount / $maxretrycount)"
        try {
          terraform destroy -auto-approve -input=false -parallelism=20 -var-file="variables-$(environment).tfvars" ${{ parameters.customAttributes }}
          $isSuccess = $true
        } catch {
          Write-Host "*** Terraform destroy failed. Retrying in $retrydelay seconds."
          $isSuccess = $false
          $retrycount++
          Start-Sleep -s $retrydelay
        }
      } while ( -not $isSuccess -and $retrycount -lt $maxretrycount )

# Delete Terraform state file. We need to run this in any case, even if variables.oldReleaseCustomSuffix=='' since Terrraform init also will always run and thereby create an empty state file
- task: AzureCLI@2
  displayName: 'Delete Terraform state file'
  inputs:
    azureSubscription: $(azureServiceConnection)
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      echo "*** Deleting Terraform state file ${{ parameters.terraformStateFilename }} on Storage Account $(terraformStorageAccount)"

      az storage blob delete --account-name $(terraformStorageAccount) `
                             --container-name tfstate `
                             --name "${{ parameters.terraformStateFilename }}" `
                             --auth-mode login
